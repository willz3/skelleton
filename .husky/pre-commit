#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Verificando arquivos modificados para executar testes..."

# Pega arquivos que est√£o no staging area (git add)
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
  echo "‚ÑπÔ∏è Nenhum arquivo modificado detectado"
  exit 0
fi

echo "üìÅ Arquivos modificados:"
echo "$STAGED_FILES"

# Coleta pastas √∫nicas que precisam de teste
FOLDERS_TO_TEST=""

for file in $STAGED_FILES; do
  # S√≥ processa arquivos da pasta src
  if echo "$file" | grep -q "^src/"; then
    # Pega o diret√≥rio do arquivo (remove o nome do arquivo)
    FILE_DIR=$(dirname "$file")
    FOLDERS_TO_TEST="$FOLDERS_TO_TEST $FILE_DIR"
  fi
done

# Remove duplicatas e espa√ßos extras
UNIQUE_FOLDERS=$(echo "$FOLDERS_TO_TEST" | tr ' ' '\n' | sort -u | tr '\n' ' ')

if [ -z "$UNIQUE_FOLDERS" ]; then
  echo "‚ÑπÔ∏è Nenhuma modifica√ß√£o em pastas com c√≥digo fonte (src/)"
  exit 0
fi

echo "üìÇ Pastas modificadas: $UNIQUE_FOLDERS"

# Verifica quais pastas t√™m testes e constr√≥i o padr√£o para Jest
TEST_PATTERN=""
FOLDERS_WITH_TESTS=""

for folder in $UNIQUE_FOLDERS; do
  # Verifica se existe pelo menos um arquivo .spec.ts na pasta (sem subpastas)
  if find "$folder" -maxdepth 1 -name "*.spec.ts" | head -1 | grep -q .; then
    # Remove o prefixo "src/" do caminho para ser relativo ao rootDir do Jest
    RELATIVE_FOLDER=$(echo "$folder" | sed 's|^src/||')
    if [ -z "$TEST_PATTERN" ]; then
      TEST_PATTERN="$RELATIVE_FOLDER/[^/]*\.spec\.ts"
    else
      TEST_PATTERN="$TEST_PATTERN|$RELATIVE_FOLDER/[^/]*\.spec\.ts"
    fi
    FOLDERS_WITH_TESTS="$FOLDERS_WITH_TESTS $folder"
  fi
done

if [ -z "$TEST_PATTERN" ]; then
  echo "‚úÖ Nenhuma pasta com testes foi modificada"
  exit 0
fi

echo "üß™ Executando testes nas pastas:$FOLDERS_WITH_TESTS"
echo "üéØ Padr√£o de teste: ($TEST_PATTERN)"
echo "üöÄ Rodando testes..."

# Executa os testes apenas nas pastas modificadas
if npx jest --testPathPattern="($TEST_PATTERN)" --passWithNoTests; then
  echo "‚úÖ Todos os testes passaram! Commit pode prosseguir."
  exit 0
else
  echo "‚ùå Alguns testes falharam. Commit cancelado."
  exit 1
fi
